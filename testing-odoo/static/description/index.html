<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Niyu eLearning RAG ‚Äî AI Assistant for Odoo 18</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --ink:#1f2937; --muted:#6b7280; --soft:#f5f7fb; --card:#ffffff; --line:#e6e9f5;
      --violet:#6c5ce7; --teal:#14b8a6; --cyan:#00bcd4;
      --violet-10:rgba(108,92,231,.10); --teal-10:rgba(20,184,166,.10);
    }
    html,body{margin:0;padding:0;background:var(--soft);color:var(--ink);font:15px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 18px}
    h1{font-size:30px;margin:0 0 8px}
    h2{font-size:22px;margin:26px 0 10px}
    h3{font-size:18px;margin:18px 0 8px}
    p{margin:8px 0}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;background:#fff;font-size:12px;margin-right:6px}
    .badge{display:inline-block;background:linear-gradient(135deg,var(--violet),var(--teal));color:#fff;padding:2px 8px;border-radius:6px;font-size:12px}
    .code{background:#0b1020;color:#e8ebff;border-radius:8px;padding:10px;font:13px/1.5 ui-monospace,Consolas,Menlo,monospace;overflow:auto}
    .kbd{font:12px ui-monospace,Consolas,Menlo,monospace;background:#f2f3fb;border:1px solid var(--line);padding:1px 6px;border-radius:6px}
    ul,ol{margin:6px 0 6px 18px}
    .logo{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;
          background:linear-gradient(135deg,rgba(108,92,231,.12),rgba(0,188,212,.10));border:1px solid var(--line);font-size:22px}
    .callout{background:linear-gradient(135deg,rgba(108,92,231,.10),rgba(20,184,166,.10));border:1px solid var(--line)}
    .ok{color:#10b981} .warn{color:#d97706} .err{color:#ef4444}
    table{border-collapse:collapse;width:100%} th,td{border:1px solid var(--line);padding:8px;text-align:left}
    th{background:linear-gradient(180deg, rgba(108,92,231,.06), rgba(20,184,166,.04))}
    .toc a{color:var(--violet);text-decoration:none} .toc a:hover{text-decoration:underline}
    .img{border:1px solid var(--line);border-radius:10px;overflow:hidden}
    /* Small helper to remove inner padding from "image cards" */
    .p0{padding:0}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HERO -->
    <div class="d-flex align-items-center gap-3 flex-wrap" style="margin-bottom:8px">
      <div class="logo">üéì</div>
      <div>
        <h1 style="margin-bottom:4px">Niyu eLearning RAG ‚Äî AI Assistant for Odoo 18</h1>
        <div class="muted">
          Ask natural questions grounded in your eLearning content. Cited answers, course filter, chat-like UX, optional employee lookup.
        </div>
      </div>
    </div>

    <!-- HIGHLIGHTS -->
    <div class="card callout">
      <strong>Highlights</strong>:
      <span class="pill">RAG over <b>Odoo eLearning</b></span>
      <span class="pill">Qdrant Vector DB</span>
      <span class="pill">OpenAI Embeddings + LLM</span>
      <span class="pill">Course filter</span>
      <span class="pill">Sources &amp; Debug</span>
      <span class="pill">Chat History (local)</span>
      <span class="pill">People lookup (optional)</span>
    </div>

    <!-- TOC -->
    <div class="card toc">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <strong>Table of contents</strong>
      </div>
      <ul style="margin-top:8px">
        <li><a href="#features">Features</a></li>
        <li><a href="#requirements">Requirements &amp; Compatibility</a></li>
        <li><a href="#install">Installation</a></li>
        <li><a href="#configure">Configuration</a></li>
        <li><a href="#use">Using the Assistant</a></li>
        <li><a href="#internals">How it works (Internals)</a></li>
        <li><a href="#routes">Endpoints (JSON-RPC)</a></li>
        <li><a href="#troubleshoot">Troubleshooting</a></li>
        <li><a href="#changelog">Changelog</a> ‚Ä¢ <a href="#license">License</a> ‚Ä¢ <a href="#support">Support</a></li>
      </ul>
    </div>

    <!-- SCREENSHOTS (full-width, 3 images) -->
    <div class="card img p0">
      <img src="/niyu_elearn_rag/static/description/screenshot-1.png"
           alt="Assistant main view"
           style="width:100%;display:block"/>
    </div>
    <div class="card img p0">
      <img src="/niyu_elearn_rag/static/description/screenshot-2.png"
           alt="Answer with sources"
           style="width:100%;display:block"/>
    </div>
    <div class="card img p0">
      <img src="/niyu_elearn_rag/static/description/screenshot-3.png"
           alt="Debug & people search"
           style="width:100%;display:block"/>
    </div>

    <!-- FEATURES -->
    <h2 id="features">Features</h2>
    <div class="card">
      <ul>
        <li><b>Grounded answers</b> on your slides with source citations (per answer) and an optional debug table of retrieved chunks.</li>
        <li><b>Course filter</b>: limit answers to one course or search across all.</li>
        <li><b>Chat UX</b>: local chat history (browser <code>localStorage</code>), quick chips, copy answer, new chat, delete chat.</li>
        <li><b>Admin panel</b>: Test Embeddings, Test Qdrant, Index Now, and last indexed timestamp.</li>
        <li><b>People search</b> (optional): find employees by name/email/title; respects access rights.</li>
        <li><b>Safe defaults</b>: if the context lacks the answer, the assistant says it doesn‚Äôt know.</li>
      </ul>
    </div>

    <!-- REQUIREMENTS -->
    <h2 id="requirements">Requirements &amp; Compatibility</h2>
    <div class="card">
      <ul>
        <li>Odoo 18 (Community or Enterprise)</li>
        <li>Modules: <code>website_slides</code> (eLearning). <code>hr</code> optional for People search.</li>
        <li>Python: <code>requests</code></li>
        <li>Qdrant running and reachable by Odoo</li>
        <li>OpenAI API key (Embeddings + Chat)</li>
      </ul>
    </div>

    <!-- INSTALL -->
    <h2 id="install">Installation</h2>
    <div class="card">
      <ol>
        <li>Clone to <code>custom_addons/niyu_elearn_rag</code> and update Apps list.</li>
        <li>Install the module. (Ensure <code>website_slides</code> is installed.)</li>
        <li>Start Qdrant. If changing embedding model later, recreate the collection to avoid vector size mismatch.</li>
      </ol>
    </div>

    <!-- CONFIGURE -->
    <h2 id="configure">Configuration</h2>
    <div class="card">
      <ol>
        <li>Go to <b>Settings ‚Üí Niyu eLearning RAG</b> (app card in General Settings).</li>
        <li>Fill in:
          <ul>
            <li><b>OpenAI API Key</b></li>
            <li><b>Embeddings Model</b> (e.g. <code>text-embedding-3-small</code>)</li>
            <li><b>LLM Model</b> (your chosen chat model)</li>
            <li><b>Qdrant URL</b> (e.g. <code>http://127.0.0.1:6333</code>) &amp; <b>Collection</b> (e.g. <code>elearning</code>)</li>
            <li><b>Retrieval</b>: Top-K, Min score (defaults provided)</li>
          </ul>
        </li>
        <li>Click <b>Save</b>.</li>
        <li>Use <b>Test Qdrant</b> and <b>Test Embeddings</b> to validate connectivity.</li>
        <li>Click <b>Index Now</b> to embed and push slides to Qdrant.</li>
      </ol>

      <h3>Config Parameters (stored in ICP)</h3>
      <table>
        <thead><tr><th>Key</th><th>Description</th><th>Example</th></tr></thead>
        <tbody>
          <tr><td><code>niyu_elearn_rag.openai_api_key</code></td><td>Secret OpenAI key</td><td>sk-‚Ä¶</td></tr>
          <tr><td><code>niyu_elearn_rag.embeddings_model</code></td><td>Embedding model name</td><td>text-embedding-3-small</td></tr>
          <tr><td><code>niyu_elearn_rag.llm_model</code></td><td>Chat model name</td><td>gpt-4o-mini</td></tr>
          <tr><td><code>niyu_elearn_rag.qdrant_url</code></td><td>Qdrant base URL</td><td>http://127.0.0.1:6333</td></tr>
          <tr><td><code>niyu_elearn_rag.qdrant_collection</code></td><td>Collection name</td><td>elearning</td></tr>
          <tr><td><code>niyu_elearn_rag.top_k</code></td><td>Default retrieval size</td><td>12</td></tr>
          <tr><td><code>niyu_elearn_rag.min_score</code></td><td>Minimum similarity score</td><td>0.25</td></tr>
          <tr><td><code>niyu_elearn_rag.last_indexed_at</code></td><td>Watermark for incremental indexing</td><td>auto</td></tr>
        </tbody>
      </table>
    </div>

    <!-- USING -->
    <h2 id="use">Using the Assistant</h2>
    <div class="card">
      <ol>
        <li>Open the client action: <b>eLearning ‚Üí AI Assistant</b> (or search for ‚ÄúNiyu eLearning Assistant‚Äù).</li>
        <li>Select a specific <b>Course</b> or leave <b>All courses</b>.</li>
        <li>Ask your question in the composer (Enter to send; Shift+Enter for new line).</li>
        <li>Review the answer and <b>Sources</b>. Toggle <b>Debug</b> to inspect retrieved chunks.</li>
        <li>Use <b>New Chat</b> to start a fresh thread. Use the history drawer (FAB) to reopen or delete conversations.</li>
        <li>(Optional) In the right panel, search <b>People</b> by name/email/title. Opens employee form with your access rights.</li>
      </ol>
      <p class="muted">Note: Chat history is stored locally in the browser via <code>localStorage</code>.</p>
    </div>

    <!-- INTERNALS -->
    <h2 id="internals">How it works (Internals)</h2>
    <div class="card">
      <ul>
        <li><b>Indexing</b> (<code>services/ingest.py</code>): reads <code>slide.slide</code> (<code>html_content</code> ‚Üí plaintext), chunks (‚âà1200 chars, 200 overlap), embeds, and upserts into Qdrant with payload:
          <div class="code">{"slide_id","slide_title","channel_id","channel_name","tags","chunk_index","url","write_date","text"}</div>
        </li>
        <li><b>Retrieval</b>: query is embedded; top-N are fetched from Qdrant with vectors. Greedy <b>MMR</b> re-ranks (diversity) and we de-dupe per slide.</li>
        <li><b>Answering</b>: system prompt enforces context-only answers and simple Markdown; <b>_attach_sources</b> replaces <code>(URL)</code> placeholders with real links and appends a Sources list.</li>
        <li><b>Security</b>: All routes are <code>auth="user"</code> and respect Odoo ACLs; course filters restrict by visible <code>slide.channel</code> IDs. People search is optional and rights-aware.</li>
      </ul>
    </div>

    <!-- ROUTES -->
    <h2 id="routes">Endpoints (JSON-RPC)</h2>
    <div class="card">
      <h3>/niyu/elearn/ask</h3>
      <p><b>POST</b> (auth user). Body:</p>
      <div class="code">{
  "jsonrpc":"2.0","method":"call","params":{
    "question":"How do I enroll employees?",
    "top_k":12, "min_score":0.25, "debug":false,
    "channel_id": 0
  }
}</div>
      <p>Response:</p>
      <div class="code">{
  "answer":"...", "sources":[{"title":"...","url":"/slides/ID"}],
  "debug":[{"score":0.71,"title":"...","url":"/slides/ID","snippet":"..."}]
}</div>

      <h3>/niyu/elearn/courses</h3>
      <p>List visible <code>slide.channel</code> (auth user).</p>

      <h3>/niyu/elearn/people/search</h3>
      <p>Optional; requires <code>hr</code>. Filters by name/email/title; can restrict to a course‚Äôs members.</p>

      <h3>/niyu/elearn/status</h3>
      <p>Admin flag and <code>last_indexed_at</code>.</p>

      <h3>/niyu/elearn/admin/*</h3>
      <ul>
        <li><code>test_embeddings</code> ‚Üí sanity check model</li>
        <li><code>test_qdrant</code> ‚Üí connectivity/version</li>
        <li><code>index_now</code> ‚Üí index updated slides</li>
      </ul>
    </div>

    <!-- TROUBLESHOOT -->
    <h2 id="troubleshoot">Troubleshooting</h2>
    <div class="card">
      <ul>
        <li><b>Missing template: ‚Äúniyu_elearn_rag.AskView‚Äù</b> ‚Äî Ensure your XML <code>t-name</code> matches the JS component‚Äôs template and the asset bundle loads it.</li>
        <li><b>‚ÄúEntity &amp;nbsp; not defined‚Äù</b> ‚Äî Don‚Äôt use HTML entities in XML; use a literal space or <code>&amp;#160;</code>.</li>
        <li><b>OwlError: reading 'length'</b> ‚Äî Guard nulls in template: use <code>state.list and state.list.length</code> or <code>state.list or []</code>.</li>
        <li><b>Qdrant vector size mismatch</b> ‚Äî If you change embeddings model, recreate the collection or point to a new one.</li>
        <li><b>Index Now returns 0</b> ‚Äî No new slides since last watermark; clear <code>last_indexed_at</code> or edit slides to re-index.</li>
        <li><b>Scroll feels stuck</b> ‚Äî Ensure the messages container has <code>overflow:auto</code> and no parent with <code>overflow:hidden</code>.</li>
        <li><b>403 / forbidden on admin</b> ‚Äî Only users in <code>base.group_system</code> can call admin routes.</li>
      </ul>
    </div>

    <!-- CHANGELOG -->
    <h2 id="changelog">Changelog</h2>
    <div class="card">
      <ul>
        <li><b>v1.0.0</b> ‚Äî First release: RAG, course filter, citations, debug, people search (opt), admin tools, chat UI.</li>
      </ul>
    </div>

    <!-- LICENSE -->
    <h2 id="license">License</h2>
    <div class="card">
      <p>Proprietary / Commercial (or fill in your chosen license).</p>
    </div>

    <!-- SUPPORT -->
    <h2 id="support">Support</h2>
    <div class="card">
      <p>Issues or feature requests? Reach us at <a href="mailto:support@niyulabs.com">support@niyulabs.com</a>.</p>
      <p>When reporting, include Odoo version, module version, a screenshot, and the <span class="kbd">Settings ‚Üí Technical ‚Üí Parameters</span> values for this module.</p>
    </div>

  </div>
</body>
</html>
