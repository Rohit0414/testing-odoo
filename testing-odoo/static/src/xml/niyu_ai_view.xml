<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

  <t t-name="niyu_odoo_ai.niyu_ai_client_action_template" owl="1">
    <div class="o_niyu_main_layout">
      <!-- ================== LEFT SIDEBAR: CHAT HISTORY ================== -->
      <div class="o_niyu_sidebar">
        <div class="o_niyu_sidebar_header">
            <i class="fa fa-brain me-2"/>
            <h5 class="m-0 fw-bold">Niyu AI Analyst</h5>
        </div>
        <div class="o_niyu_sidebar_actions">
            <button class="btn btn-primary w-100" t-on-click="onNewChat">
                <i class="fa fa-plus-circle me-1"/> New Chat
            </button>
        </div>
        <div class="o_niyu_chat_list">
            <t t-if="state.chatHistory.length === 0">
                <div class="o_niyu_no_chats text-muted text-center p-3 small">
                    <i class="fa fa-comments-o fa-2x mb-2"/>
                    <p>Your recent chats will appear here.</p>
                </div>
            </t>
            <t t-foreach="state.chatHistory" t-as="chat" t-key="chat.id">
                <div t-attf-class="o_niyu_chat_list_item {{ state.activeChatId === chat.id ? 'active' : '' }}"
                     t-on-click="() => this.onSelectChat(chat.id)">
                    <i class="fa fa-comment-o me-2"/>
                    <span class="o_niyu_chat_title flex-grow-1"><t t-esc="chat.title"/></span>
                    <i class="fa fa-trash-o o_niyu_delete_chat" title="Delete Chat" t-on-click.stop="() => this.onDeleteChat(chat.id)"/>
                </div>
            </t>
        </div>
      </div>

      <!-- ================== RIGHT PANEL: ACTIVE CHAT WINDOW ================== -->
      <div class="o_niyu_chat_window">
        <!-- Show welcome screen if no chat is active -->
        <div t-if="!state.activeChatId" class="o_niyu_welcome_screen">
            <i class="fa fa-comments fa-4x text-primary mb-4"/>
            <h2 class="fw-light">Welcome to Niyu AI</h2>
            <p class="text-muted">Start a new conversation or select a previous one from the left.</p>
            <button class="btn btn-lg btn-primary mt-3" t-on-click="onNewChat">
                <i class="fa fa-plus-circle me-1"/> Start New Chat
            </button>
        </div>

        <!-- Show active chat conversation -->
        <t t-else="">
            <div class="o_niyu_chat_history" t-ref="chatHistory">
              <t t-foreach="state.activeConversation" t-as="message" t-key="message.id">
                <div t-attf-class="o_niyu_chat_message {{ message.role === 'user' ? 'o_niyu_message_user' : 'o_niyu_message_assistant' }}">
                  <div class="o_niyu_message_avatar">
                    <i t-attf-class="fa {{ message.role === 'user' ? 'fa-user-circle' : 'fa-robot' }}"/>
                  </div>
                  <div class="o_niyu_message_content_wrapper">
                    <div class="o_niyu_message_content">
                      <t t-if="message.isLoading"><div class="o_niyu_typing_indicator"><span/><span/><span/></div></t>
                      <t t-else=""><div t-att-class="message.isError ? 'text-danger' : ''" style="white-space: pre-wrap;"><t t-esc="message.content"/></div></t>
                    </div>
                    <div t-if="message.role === 'assistant' and !message.isLoading and message.sql" class="o_niyu_message_actions">
                        <button class="btn btn-sm btn-link" t-on-click="() => this.toggleSqlVisibility(message)"><i class="fa fa-code me-1"/> <t t-if="!message.showSql">Show SQL</t><t t-else="">Hide SQL</t></button>
                    </div>
                    <div t-if="message.showSql and message.sql" class="o_niyu_sql_viewer mt-2">
                      <div class="position-relative">
                          <pre><code><t t-esc="message.sql"/></code></pre>
                          <button class="btn btn-sm btn-outline-secondary" t-on-click="() => this.copySQLToClipboard(message.sql)" title="Copy SQL"><i class="fa fa-copy"/></button>
                      </div>
                    </div>
                  </div>
                </div>
              </t>
            </div>
            <div class="o_niyu_chat_input_form">
              <div class="o_niyu_input_wrapper">
                <textarea class="form-control" t-ref="queryInput" rows="1" placeholder="Ask a follow-up..." t-on-keydown="onInputKeydown" t-att-disabled="state.isLoading"/>
                <button class="btn btn-primary o_niyu_send_btn" t-on-click="onAskAI" t-att-disabled="state.isLoading">
                  <t t-if="state.isLoading"><span class="spinner-border spinner-border-sm"/></t>
                  <t t-else=""><i class="fa fa-paper-plane"/></t>
                </button>
              </div>
            </div>
        </t>
      </div>
    </div>

    <!-- All styling is centralized here -->
    <style>
        .o_niyu_main_layout { display: flex; height: 100vh; width: 100%; background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        
        /* Sidebar Styles */
        .o_niyu_sidebar { display: flex; flex-direction: column; width: 280px; background-color: #e9ecef; border-right: 1px solid #dee2e6; flex-shrink: 0; }
        .o_niyu_sidebar_header { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #dee2e6; color: #343a40; }
        .o_niyu_sidebar_actions { padding: 1rem; border-bottom: 1px solid #dee2e6; }
        .o_niyu_chat_list { flex-grow: 1; overflow-y: auto; padding: 0.5rem; }
        .o_niyu_chat_list_item { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.2s; }
        .o_niyu_chat_list_item:hover { background-color: #dee2e6; }
        .o_niyu_chat_list_item.active { background-color: #0d6efd; color: white; }
        .o_niyu_chat_title { overflow: hidden; text-overflow: ellipsis; }
        .o_niyu_delete_chat { margin-left: auto; opacity: 0; transition: opacity 0.2s; padding: 0.25rem; }
        .o_niyu_chat_list_item:hover .o_niyu_delete_chat { opacity: 0.6; }
        .o_niyu_chat_list_item:hover .o_niyu_delete_chat:hover { opacity: 1; }

        /* Main Chat Window Styles */
        .o_niyu_chat_window { display: flex; flex-direction: column; flex-grow: 1; height: 100vh; }
        .o_niyu_welcome_screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .o_niyu_chat_history { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .o_niyu_chat_input_form { padding: 1rem; border-top: 1px solid #dee2e6; background-color: #f8f9fa; flex-shrink: 0; padding-bottom:70px; }
        .o_niyu_input_wrapper { display: flex; align-items: center; gap: 0.75rem; max-width: 900px; margin: auto; }
        
        /* Re-used bubble styles */
        .o_niyu_chat_message { display: flex; align-items: flex-start; gap: 0.75rem; max-width: 85%; }
        .o_niyu_message_avatar { font-size: 1.5rem; color: #6c757d; padding-top: 0.25rem; }
        .o_niyu_message_content_wrapper { flex-grow: 1; }
        .o_niyu_message_content { padding: 0.75rem 1rem; border-radius: 0.75rem; line-height: 1.5; word-break: break-word; }
        .o_niyu_message_user { align-self: flex-end; flex-direction: row-reverse; }
        .o_niyu_message_user .o_niyu_message_content { background-color: #0d6efd; color: white; }
        .o_niyu_message_assistant { align-self: flex-start; }
        .o_niyu_message_assistant .o_niyu_message_content { background-color: #e9ecef; color: #212529; }
        .o_niyu_message_actions { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
        .o_niyu_sql_viewer pre { white-space: pre-wrap; word-break: break-all; background-color: #f1f3f5; font-size: 0.85em; padding: 0.5rem; border: 1px solid #dee2e6; border-radius: 0.25rem; }
        .o_niyu_sql_viewer .position-relative { display: flex; align-items: start; justify-content: space-between; }
        .o_niyu_input_wrapper textarea { flex-grow: 1; border-radius: 2rem; padding: 0.5rem 1.25rem; resize: none; }
        .o_niyu_send_btn { flex-shrink: 0; border-radius: 50%; width: 42px; height: 42px; }
        .o_niyu_typing_indicator span { height: 8px; width: 8px; border-radius: 50%; background-color: #6c757d; display: inline-block; animation: typing 1s infinite; }
        .o_niyu_typing_indicator span:nth-child(2) { animation-delay: 0.1s; }
        .o_niyu_typing_indicator span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    </style>
  </t>

</templates>